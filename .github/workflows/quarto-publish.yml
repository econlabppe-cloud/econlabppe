name: "Publish Quarto Book â†’ GitHub Pages"

on:
  push:
    branches:
      - main
    paths-ignore:
      - "Members/**"
      - "Data/**"
      - ".github/ISSUE_TEMPLATE/**"
      - "*.py"
  workflow_dispatch:          # allow manual trigger from Actions tab

permissions:
  contents: write             # needed to push to gh-pages
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false   # don't cancel mid-deploy; queue instead

jobs:
  build-and-deploy:
    name: "Render & Deploy"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # full history for git-based features

      # â”€â”€ 2. Setup R (needed for R code in Quarto) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Setup R"
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.3"
          use-public-rspm: true

      - name: "Install R packages"
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            tidyverse
            ggplot2
            dplyr
            tidyr
            readr
            lubridate
            broom
            knitr
            rmarkdown
        continue-on-error: true    # don't fail build if optional R pkgs missing

      # â”€â”€ 3. Setup Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: "Install Python packages"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: true    # don't fail build if optional pkgs missing

      # â”€â”€ 4. Setup Quarto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Setup Quarto"
        uses: quarto-dev/quarto-actions/setup@v2

      # â”€â”€ 5. Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Render Quarto book"
        run: quarto render
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 6. Add CNAME if custom domain is configured â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Add CNAME (optional)"
        run: |
          if [ -f CNAME ]; then
            cp CNAME _book/CNAME
          fi

      # â”€â”€ 7. Deploy to gh-pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Publish to GitHub Pages"
        uses: quarto-dev/quarto-actions/publish@v2
        with:
          target: gh-pages
          path: _book
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 8. Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Print deployment summary"
        if: success()
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š The EconLabPPE Quarto book has been published to **GitHub Pages**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Site URL: https://\${{ github.repository_owner }}.github.io/econlabppe" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• Published at: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
