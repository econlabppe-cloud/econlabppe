# שבוע 4 – Excel מתקדם: Power Query, פונקציות פיננסיות, ודשבורד כלכלי


### 🎥 סרטוני הדרכה לפרק זה
כדי לכסות את החומר מכל הזוויות, ריכזנו עבורכם 3 סרטונים ברמות קושי שונות:
::: {.panel-tabset}
## 🟢 רמת מתחילים
**מבוא והיכרות עם המושגים הבסיסיים:**
{{< video [https://www.youtube.com/watch?v=QXzopqpHlSs](https://www.youtube.com/watch?v=QXzopqpHlSs) >}}
## 🟡 רמת ביניים
**העמקה ופרקטיקה מעשית:**
{{< video [https://www.youtube.com/watch?v=L4Bhs_v1BBA](https://www.youtube.com/watch?v=L4Bhs_v1BBA) >}}
## 🔴 רמת מתקדמים
**מקרי קצה, אופטימיזציה ושימושים מורכבים:**
{{< video [https://www.youtube.com/watch?v=sOen7Z8tKpw](https://www.youtube.com/watch?v=sOen7Z8tKpw) >}}
:::



## 🟢 רמת מתחילים
**מבוא והיכרות עם המושגים הבסיסיים:**
{{< video https://www.youtube.com/watch?v=MeUPugsWmZA >}}

## 🟡 רמת ביניים
**העמקה ופרקטיקה מעשית:**
{{< video https://www.youtube.com/watch?v=QXzopqpHlSs >}}

## 🔴 רמת מתקדמים
**מקרי קצה, אופטימיזציה ושימושים מורכבים:**
{{< video https://www.youtube.com/watch?v=sOen7Z8tKpw >}}

:::
## מה נלמד השבוע?

| נושא | זמן משוער |
|---|---|
| Power Query: ETL ב-Excel | 120 דקות |
| פונקציות פיננסיות: NPV, IRR, PMT | 90 דקות |
| פונקציות מתקדמות: XLOOKUP, SUMPRODUCT | 60 דקות |
| Sparklines + Advanced Charts | 45 דקות |
| בניית Dashboard מאקרו-כלכלי | 120 דקות |
| הגנה ושיתוף קובץ | 30 דקות |
| **סה"כ** | **~8 שעות** |

---

## חלק א – Power Query: ETL מבלי לכתוב קוד

### מה זה Power Query?

Power Query הוא **מנוע עיבוד נתונים** שמובנה ב-Excel מאז 2016.
זה בעצם "Python Pandas ל-Excel" – מאפשר לנקות, לשנות צורה, ולמזג נתונים **ולשמור את השלבים** לריצה חוזרת.

**למה Power Query ולא נוסחאות?**
- ניקוי נתונים חד-פעמי → נוסחאות OK
- ניקוי נתונים שחוזר על עצמו (כל חודש) → Power Query!
- כל שלב מתועד ואפשר לבטל/לשנות

### יצירת Query ראשון

1. הורד נתוני ייצוא מ-[govexcel.example.com](https://www.cbs.gov.il) (CSV)
2. Data → Get Data → From File → From CSV

**חלון Power Query Editor נפתח:**

```
┌────────────────────────────────────────────────┐
│  Applied Steps (שלבים מוחלים):                │
│  ✓ Source                                      │
│  ✓ Promoted Headers                            │
│  ✓ Changed Type                                │
│  + [כל שלב ניקוי שתוסיף יופיע כאן]          │
└────────────────────────────────────────────────┘
```

### ניקוי נתונים ב-Power Query

**שלב 1: הסרת שורות ריקות**
Home → Remove Rows → Remove Blank Rows

**שלב 2: שינוי סוג נתונים**
לחץ על אייקון הסוג ליד שם עמודה → בחר: Decimal Number / Text / Date

**שלב 3: סינון שורות**
לחץ על חץ בעמודה → Number Filters → Greater Than

**שלב 4: Unpivot עמודות**

אתגר נפוץ: נתונים ב"פורמט רחב":
```
שנה    Q1    Q2    Q3    Q4
2022   100   105   108   103
2023   98    101   104   102
```

ל"פורמט ארוך" (נכון לניתוח):
```
שנה    רבעון    ערך
2022   Q1        100
2022   Q2        105
...
```

1. סמן עמודות Q1, Q2, Q3, Q4
2. Transform → Unpivot Columns
3. שנה שמות: "Attribute" → "רבעון", "Value" → "ערך"

**שלב 5: הוספת עמודה מחושבת**
Add Column → Custom Column:
```
= [Q1_value] * 1.17
```

### מיזוג (Merge) שתי טבלאות

Home → Merge Queries → בחר שתי Query ← הגדר על איזה עמודה למזג

זה בדיוק כמו JOIN ב-SQL – נלמד עוד ב-SQL Module.

### ריענון אוטומטי

כשהנתונים מתעדכנים (קובץ CSV חדש מוחלף), לחץ:
Data → Refresh All

כל הניקוי, החישובים, ה-Pivots – מתעדכנים אוטומטית!

---

## חלק ב – פונקציות פיננסיות

### הקשר הכלכלי

כלכלנים בסקטור הפרטי (בנקים, ייעוץ, פינ-טק) **חייבים** להבין חישובי ערך נוכחי.

### 1. NPV – ערך נוכחי נקי (Net Present Value)

**שאלה כלכלית:** ממשלה שוקלת פרויקט תשתית (כביש חדש) עם השקעה ראשונית ותזרים הכנסות.
האם הפרויקט כדאי מבחינה כלכלית?

```excel
=NPV(discount_rate, value1, value2, ...) + initial_investment
```

**דוגמה מלאה:**

```
A             B
שנה           תזרים (מיליון ₪)
0 (השקעה)    -500
1            80
2            90
3            100
4            110
5            120
6            130
7            140
8            150
9            160
10           170
```

```excel
# ריבית היוון = 5% (ריבית הנחה של הממשלה)
# NPV בתא C1:
=NPV(5%, B2:B11) + B1

# אם NPV > 0 → הפרויקט כדאי
# אם NPV < 0 → הפרויקט לא כדאי
```

**ניתוח רגישות:**
```excel
# בדוק NPV בריביות שונות:
=NPV(3%, B2:B11) + B1   → NPV ב-3%
=NPV(5%, B2:B11) + B1   → NPV ב-5%
=NPV(7%, B2:B11) + B1   → NPV ב-7%
=NPV(10%, B2:B11) + B1  → NPV ב-10%
```

### 2. IRR – שיעור תשואה פנימי (Internal Rate of Return)

IRR = **ריבית ההיוון שמאפסת את ה-NPV**. אם IRR > ריבית הנחה ממשלתית → הפרויקט כדאי.

```excel
=IRR(B1:B11)
```

**כלל אצבע:** IRR > ריבית בנק ישראל (4.5%) → הפרויקט כדאי.

### 3. PMT – תשלום חודשי (Payment)

**שאלה:** אם ממשלה לוקחת הלוואה של 1 מיליארד ₪ ל-10 שנים בריבית 4% – כמה תשלם בחודש?

```excel
=PMT(rate, nper, pv)

=PMT(4%/12, 10*12, -1000000000)
# → מחזיר תשלום חודשי בשקלים
```

| פרמטר | ערך | הסבר |
|---|---|---|
| rate | 4%/12 | ריבית חודשית (שנתית / 12) |
| nper | 10*12 | מספר תשלומים (10 שנים × 12 חודשים) |
| pv | -1,000,000,000 | סכום ההלוואה (שלילי כי יוצא מהכיס) |

### 4. FV – ערך עתידי (Future Value)

**שאלה:** קרן פנסיה מפקידה 2,000 ₪ בחודש. מה יהיה שוויה אחרי 30 שנה ב-6% תשואה שנתית?

```excel
=FV(6%/12, 30*12, -2000, 0)
```

### טבלת רגישות: NPV לפי ריבית וזמן

1. צור טבלת 2D עם ריביות בשורה ושנות פרויקט בעמודה
2. בתא הפינה שמאל-עליון: `=NPV_formula`
3. סמן כל הטבלה → Data → What-If Analysis → Data Table
4. Row input cell: תא הריבית; Column input cell: תא מספר השנים

---

## חלק ג – פונקציות מתקדמות

### XLOOKUP – הגרסה המשופרת של VLOOKUP

זמין ב-Excel 365 ו-2021+. פשוט יותר, עוצמתי יותר.

```excel
=XLOOKUP(lookup_value, lookup_array, return_array, [if_not_found])
```

**יתרונות על VLOOKUP:**
- מחפש בכל כיוון (גם שמאלה!)
- מחזיר הודעה מותאמת אם לא נמצא
- יכול לחפש מהסוף להתחלה

```excel
=XLOOKUP("ירושלים", A:A, D:D, "לא נמצא")
```

### SUMPRODUCT – מחשב הכל בבת אחת

```excel
=SUMPRODUCT(array1, array2, ...)
```

**שאלה:** ממוצע משוקלל של אינפלציה לפי משקל תקציב:

```
שנה    אינפלציה    משקל תקציב
2021   1.5%        0.25
2022   5.1%        0.30
2023   4.2%        0.28
2024   3.5%        0.17
```

```excel
=SUMPRODUCT(B2:B5, C2:C5) / SUM(C2:C5)
```

**שימוש נוסף – COUNT עם תנאים מרובים:**
```excel
=SUMPRODUCT((A2:A100="תל אביב")*(B2:B100>5000))
```
ספור כמה שורות עם "תל אביב" **וגם** ערך > 5000.

### INDIRECT – reference דינמי

```excel
=INDIRECT("Sheet"&A1&"!B5")
```
אם A1 = "2022", מחזיר את הערך מ-Sheet2022!B5.
שימושי לבניית דשבורד שמושך מגיליונות שנתיים.

---

## חלק ד – Sparklines ו-Advanced Charts

### Sparklines – גרפים מיניאטוריים בתא

Sparklines הם גרפים קטנים שמתאימים לתא אחד – מעולים לדשבורד.

1. לחץ על תא ריק ליד שורת נתונים
2. Insert → Sparklines → Line
3. Data Range: בחר שורת נתונים (לדוגמה, B2:M2)
4. Location Range: תא שבחרת
5. OK

**עיצוב:** לחץ על Sparkline → Sparkline tab:
- Markers: סמן High ✅, Low ✅ (מסמן נקודות מינ'/מקס')
- Style: בחר צבע

### Waterfall Chart – כמה שינוי מאחד לשני?

מצוין להצגת השינוי בתמ"ג: מה תרם לצמיחה? (צריכה, השקעות, ייצוא, ממשלה)

1. הכן נתוני "תרומה לצמיחה":
```
קטגוריה          תרומה %
נקודת מוצא      0
צריכה פרטית     +2.1
השקעות           +1.8
ייצוא            +0.9
ממשלה            +0.5
יבוא (שלילי)     -1.4
סה"כ צמיחה       3.9
```

2. Insert → Chart → Waterfall
3. לחץ ימין על עמודת "נקודת מוצא" ו"סה"כ" → Set as Total

### Bullet Chart: ביצועים מול יעד

לא מובנה ב-Excel אבל אפשר לדמות:
- עמודת Stacked Bar ממוקמת על גבי עמודה מלאה
- מציגה: ביצוע בפועל + יעד + טווחי ביצוע (טוב/בינוני/גרוע)

---

## חלק ה – בניית דשבורד מאקרו-כלכלי

### עיקרון: דשבורד = לוח בקרה בהשהייה אחת

דשבורד טוב:
- מציג **4-6 KPIs** בראש (מספרים גדולים)
- **2-3 גרפים** למגמות
- **1 טבלה** לפרטים
- **Slicers** לסינון לפי זמן/מחוז

### שלב 1: גיליון נתונים (אל תנגעו בו!)

צור גיליון `RAW_DATA` עם כל הנתונים הגולמיים. **ננעל אחר כך.**

### שלב 2: גיליון חישובים

צור גיליון `CALC` עם כל הנוסחאות:
```excel
# KPI 1: ממוצע צמיחה (שלוש שנים אחרונות)
=AVERAGE(OFFSET(RAW_DATA!B2, COUNT(RAW_DATA!B:B)-3, 0, 3, 1))

# KPI 2: שיעור אינפלציה הנוכחי
=INDEX(RAW_DATA!C:C, COUNT(RAW_DATA!C:C)+1)

# KPI 3: שיעור ריבית הנוכחי
=INDEX(RAW_DATA!E:E, COUNT(RAW_DATA!E:E)+1)
```

### שלב 3: גיליון הדשבורד

```
┌──────────────────────────────────────────────────────────────────┐
│           דשבורד מאקרו-כלכלי ישראל              [שנה: 2024 ▼]   │
├────────────┬────────────┬────────────┬────────────┬─────────────┤
│  צמיחת   │ אינפלציה  │  אבטלה   │   ריבית   │  ייצוא     │
│  תמ"ג    │            │            │            │             │
│   1.1%    │   3.5%    │    4.2%   │   4.5%    │  $71B      │
│  ▼ vs 2023│ ▼ vs 2023 │ ▲ vs 2023 │ ▼ vs 2023 │ ▼ vs 2023  │
├────────────┴────────────┴────────────┴────────────┴─────────────┤
│                                                                   │
│  [גרף: תמ"ג + ריבית 5 שנים]    [גרף: אינפלציה + ריבית]       │
│                                                                   │
├────────────────────────────────────┬─────────────────────────────┤
│  [Pivot: ביצועים מחוזיים]          │  [Sparklines: כל המדדים]   │
└────────────────────────────────────┴─────────────────────────────┘
```

### שלב 4: עיצוב מקצועי

**צבעי הדשבורד:**
- רקע: כחול כהה (#1F3A6B) או אפור כהה (#2C3E50)
- כותרות KPI: לבן
- מספרים גדולים: לבן, גופן 36pt, Bold
- גרפים: רקע שקוף, קווי לבן
- הסר gridlines: View → uncheck Gridlines

**טיפ:** השתמש ב-Camera Tool (כלי מתקדם):
Insert → Camera → לצלם טווח מגיליון אחד ולהדביק כ"תמונה חיה" בדשבורד. ← מאפשר להציג Pivot Table כחלק חלק מהדשבורד.

### שלב 5: נעילה והגנה

**נעל גיליון RAW_DATA:**
Review → Protect Sheet → סמן ✅ "Select unlocked cells" → הגדר סיסמה (אופציונלי)

**הסתר גיליון CALC:**
לחץ ימין על לשונית → Hide

---

## חלק ו – פרויקט מסכם: דשבורד ניתוח מדיניות

### הנחיות הפרויקט

**שאלת מחקר:**
"מה ההשפעה של העלאות הריבית ב-2022-2023 על מדדי המאקרו הישראליים?"

**מה לבנות:**

1. **Power Query:** ייבוא וניקוי נתוני בנק ישראל (ריבית + CPI + שע"ח)
2. **ניתוח NPV:** חשב את עלות הסחר-off של הריבית הגבוהה על גידול תמ"ג
3. **Pivot Table:** השוואה Pre/Post העלאת ריבית (לפי מחוז אם יש נתונים)
4. **דשבורד:** 2 עמודות, לפחות 4 KPIs, 3 גרפים, 1 Slicer
5. **מסקנה:** 1 עמוד טקסט עם ממצאים

**מקורות נתונים:**
- ריבית: [boi.org.il → מדיניות מוניטרית](https://www.boi.org.il)
- CPI: [cbs.gov.il → מחירים](https://www.cbs.gov.il)

---

## הגשה

```
Members/YourName/Week_04/
├── macro_dashboard.xlsx      ← הדשבורד המלא
└── week04_analysis.md        ← ניתוח וממצאים
```

**בקובץ הניתוח:**
```markdown
# ניתוח השפעת מדיניות הריבית – ישראל 2022-2024

## תקציר מנהלים (Executive Summary)
[3-4 משפטים בלבד]

## שאלת המחקר
...

## נתונים ומתודולוגיה
...

## ממצאים עיקריים
1. ...
2. ...
3. ...

## מגבלות הניתוח
...

## המלצות מדיניות
...
```

---

## קיצורי מקשים מתקדמים

| קיצור | פעולה |
|---|---|
| Alt+D+P | Pivot Table (גרסאות ישנות) |
| Alt+F11 | VBA Editor |
| Ctrl+Shift+L | הפעל/כבה Filter |
| Alt+= | AutoSum |
| F4 | Absolute Reference |
| Ctrl+T | הפוך לטבלה |
| Ctrl+Shift+Enter | Array Formula |

---

## ללמוד עוד

- [Power Query Documentation](https://docs.microsoft.com/power-query)
- [Excel Jet – Financial Functions](https://exceljet.net/functions/financial)
- [Chandoo Dashboard Tutorials](https://chandoo.org/wp/excel-dashboards/)

---

**מודול הבא:** SQL – שפת הנתונים שמאחורי כל מסד נתונים → [שבוע 5](../Week_05_SQL_Basics/README.md)

### 💻 תרגול מעשי (Hands-on)

<p>לחצו על המשולש (Play) כדי להפעיל את סביבת הפיתוח בתוך העמוד, או פתחו בלשונית חדשה לנוחות מירבית.</p>
<iframe src="https://colab.research.google.com/github/econlabppe-cloud/econlabppe/blob/main/Assignments/Week_04_Excel_Advanced/starter_notebook.ipynb" width="100%" height="600" frameborder="0" allowfullscreen></iframe>
<p><br><em>* אם המסך לא נטען או מבקש הרשאות אבטחה, <a href="https://colab.research.google.com/github/econlabppe-cloud/econlabppe/blob/main/Assignments/Week_04_Excel_Advanced/starter_notebook.ipynb" target="_blank">לחצו כאן לפתיחת המחברת במסך מלא</a>.</em></p>
---
### 🧠 בחן את עצמך (שאלות סיכום)
לפני שאתם מתקדמים, ודאו שהבנתם את העוצמה של Power Query:

<details>
<summary><b>שאלה 1: למה כדאי להשתמש ב-Power Query במקום סתם להעתיק ולהדביק נתונים באקסל?</b> 👁️ לחץ לתשובה</summary>
<br>
Power Query שומר את "צעדי הניקוי" שלכם. בפעם הבאה שתקבלו קובץ נתונים חדש (למשל בחודש הבא), תצטרכו רק ללחוץ על Refresh (רענן) וכל תהליך הניקוי, הסינון והמיזוג יקרה אוטומטית! בנוסף, הוא יכול להתמודד בקלות עם קבצים שגדולים ממגבלת מיליון השורות של אקסל.
</details>

<details>
<summary><b>שאלה 2: מה ההבדל בין פעולת Append לפעולת Merge ב-Power Query?</b> 👁️ לחץ לתשובה</summary>
<br>
<b>Append</b> מחבר טבלאות זו תחת זו (מוסיף שורות, כמו לחבר נתונים של שנת 2022 לנתוני 2023).
<br><b>Merge</b> מחבר טבלאות זו לצד זו (מוסיף עמודות, בדומה ל-VLOOKUP, למשל חיבור טבלת עסקאות עם טבלת פרטי לקוחות לפי תעודת זהות).
</details>


---

### 💬 הערות, שאלות ודיונים
יש לכם שאלה על החומר של פרק זה? משהו לא עבד במחברת התרגול? מצאתם דרך יעילה יותר לכתוב את הקוד?
**כתבו לנו כאן למטה!** המערכת מחוברת ישירות לגיטהאב של הקורס. כל שאלה שתשאלו כאן תישמר אוטומטית בצורה מסודרת תחת נושא זה, והצוות (או סטודנטים אחרים) יוכלו לענות לכם ולעזור.
